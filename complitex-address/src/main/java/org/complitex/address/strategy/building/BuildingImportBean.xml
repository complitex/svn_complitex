<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.complitex.address.strategy.building.BuildingImportBean">
    
    <resultMap id="buildingImport" type="org.complitex.address.strategy.building.entity.BuildingImport">
        <id column="id" property="id"/>
        <result column="distr_id" property="distrId"/>
        <result column="street_id" property="streetId"/>
        <result column="num" property="num"/>
        <result column="part" property="part"/>
        <result column="processed" property="processed"/>
        <collection property="buildingSegmentImports" ofType="org.complitex.address.strategy.building.entity.BuildingSegmentImport">
            <id column="part_id" property="id"/>
            <result column="gek" property="gek"/>
            <result column="code" property="code"/>
            <result column="building_import_id" property="buildingImportId"/>
        </collection>
    </resultMap>

    <select id="getBuildingImportId" parameterType="map" resultType="long">
        SELECT `id` FROM `building_import` WHERE `street_id` = #{streetId} AND `num` = #{num} AND `part` = #{part} 
        LIMIT 0,1
    </select>
    
    <select id="getBuildingImports" parameterType="int" resultMap="buildingImport">
        SELECT b.*, p.`id` part_id, p.`gek`, p.`code`, p.`building_import_id`
            FROM (SELECT b.* FROM `building_import` b WHERE b.`processed` = 0 LIMIT ${value}) b
        LEFT OUTER JOIN `building_segment_import` p ON p.`building_import_id` = b.`id`
    </select>
    
    <update id="markProcessed" parameterType="long">
        UPDATE `building_import` SET `processed` = 1 WHERE `id` = #{id}
    </update>

    <insert id="insertBuildingImport" parameterType="org.complitex.address.strategy.building.entity.BuildingImport"
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO `building_import` (`distr_id`, `street_id`, `num`, `part`)
          VALUES (#{distrId}, #{streetId}, #{num}, #{part})
    </insert>

    <insert id="insertBuildingSegmentImport" parameterType="org.complitex.address.strategy.building.entity.BuildingSegmentImport">
        INSERT INTO `building_segment_import` (`id`, `gek`, `code`, `building_import_id`)
            VALUES (#{id}, #{gek}, #{code}, #{buildingImportId})
    </insert>

    <delete id="deleteBuildingSegmentImport">
        DELETE FROM `building_segment_import`
    </delete>
    
    <delete id="deleteBuildingImport">
        DELETE FROM `building_import`
    </delete>

</mapper>
