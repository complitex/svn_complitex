<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.complitex.address.strategy.street.Street">

    <select id="find" resultMap="org.complitex.dictionary.entity.DomainObject.DomainObject" parameterType="DomainObjectExample">
        SELECT e.* FROM `street` e WHERE
        <include refid="org.complitex.dictionary.entity.DomainObject.statusFilter"/>
        <include refid="org.complitex.dictionary.entity.DomainObject.permissionFilter"/>
        <include refid="org.complitex.dictionary.entity.DomainObject.filter"/>
        <include refid="org.complitex.address.strategy.street.Street.filterByDistrict"/>
        <include refid="org.complitex.dictionary.entity.DomainObject.orderBy"/>
        <include refid="org.complitex.dictionary.entity.DomainObject.limit"/>
    </select>
    
    <sql id="filterByDistrict">
        <if test="additionalParams != null and additionalParams['district'] != null">
            AND (EXISTS(
                    SELECT 1 FROM `building` b
                        JOIN `building_attribute` district_attr ON (b.`object_id` = district_attr.`object_id` AND district_attr.`status` = 'ACTIVE' AND district_attr.`attribute_type_id` = 500
                            AND district_attr.`value_id` = #{additionalParams.district})
                        JOIN `building_address` addr ON (b.`parent_id` = addr.`object_id` AND addr.`parent_entity_id` = 300)
                    WHERE b.`status` IN ('ACTIVE', 'INACTIVE') AND addr.`parent_id` = e.`object_id`
                    )
                 OR
                 EXISTS(
                    SELECT 1 FROM `building` b
                        JOIN `building_address` addr ON (addr.`status` IN ('ACTIVE', 'INACTIVE') AND addr.`parent_entity_id` = 300)
                        JOIN `building_attribute` district_attr ON (b.`object_id` = district_attr.`object_id` AND district_attr.`status` = 'ACTIVE' AND district_attr.`attribute_type_id` = 500
                            AND district_attr.`value_id` = #{additionalParams.district})
                        JOIN `building_attribute` ref_attr ON (b.`object_id` = ref_attr.`object_id` AND ref_attr.`status` = 'ACTIVE' AND ref_attr.`attribute_type_id` = 501
                            AND ref_attr.`value_id` = addr.`object_id`)
                    WHERE b.`status` IN ('ACTIVE', 'INACTIVE') AND addr.`parent_id` = e.`object_id`
                    )
            )
        </if>
    </sql>

    <select id="count" resultType="integer" parameterType="DomainObjectExample">
        SELECT COUNT(*) FROM `street` e WHERE
        <include refid="org.complitex.dictionary.entity.DomainObject.statusFilter"/>
        <include refid="org.complitex.dictionary.entity.DomainObject.permissionFilter"/>
        <include refid="org.complitex.dictionary.entity.DomainObject.filter"/>
        <include refid="org.complitex.address.strategy.street.Street.filterByDistrict"/>
    </select>

    <!-- Validation -->

    <!-- Default validation -->
    <select id="defaultValidation" resultType="long" parameterType="map">
        SELECT DISTINCT s.`object_id` FROM `street` s
                                    JOIN `street_attribute` a_name ON (s.`object_id` = a_name.`object_id` AND a_name.`status` = 'ACTIVE')
                                    JOIN `street_attribute` a_type ON (s.`object_id` = a_type.`object_id` AND a_type.`status` = 'ACTIVE')
                                    JOIN `street_string_culture` sc ON (a_name.`value_id` = sc.`id`)
            WHERE (s.`status` IN ('ACTIVE', 'INACTIVE')) AND sc.`locale_id` = #{localeId} AND a_name.`attribute_type_id` = 300
            AND a_type.`attribute_type_id` = 301
            AND sc.`value` = #{text}
            <choose>
                <when test="parentEntityId != null and parentId != null">
                    AND s.`parent_entity_id` = #{parentEntityId} AND s.`parent_id` = #{parentId}
                </when>
                <otherwise>
                    AND s.`parent_entity_id` IS NULL AND s.`parent_id` IS NULL
                </otherwise>
            </choose>
            AND a_type.`value_id` = #{streetTypeId}
    </select>

</mapper>